/*1.4.1*/
CREATE TEMPORARY TABLE PMAX (
        SELECT  
                SEQ.MATERIA,
                SEN.PARTIDO,
                TV.SIGLA,
                SEQ.RESULTADO,
                SEQ.DATA,
                COUNT(TV.SIGLA) AS QTD
        FROM base_senado.voto VT
        LEFT JOIN base_senado.senador SEN 	ON VT.idSENADOR = SEN.idSENADOR
        LEFT JOIN base_senado.sequencia SEQ 	ON VT.idSEQUENCIA = SEQ.idSEQUENCIA
        LEFT JOIN base_senado.tipo_voto TV 	ON VT.idTIPO_VOTO = TV.idTIPO_VOTO
        LEFT JOIN base_senado.tipo_sessao TS 	ON SEQ.TIPO_SESSAO = TS.idTIPO_SESSAO
        WHERE TS.idTIPO_SESSAO IN (1, 3) /*Filtro para selecionar apenas proposicoes que foram normais e complementares e nao secretas*/
		AND SEQ.RESULTADO IN ('Aprovado', 'Rejeitado') /*Filtro para selecionar apenas proposicoes que foram aprovadas e rejeitadas*/
		/*AND TV.idTIPO_VOTO IN (2, 5, 15, 16) /*Filtro para selecionar apenas votos especificos*/
        GROUP BY SEQ.MATERIA, SEN.PARTIDO, TV.SIGLA, SEQ.RESULTADO, SEQ.DATA
);
CREATE TEMPORARY TABLE VOTOPARTIDO (
        SELECT
              PMAX.MATERIA,
              PMAX.PARTIDO,
              PMAX.RESULTADO,
              PMAX.DATA,
              MAX(PMAX.SIGLA) AS SIGLA,
              MAX(PMAX.QTD) AS QTD
        FROM PMAX 
        /*WHERE
        PMAX.SIGLA NOT IN ('Presidente (art. 51 RISF)'/*, 'P-NRV', 'Abstenção', 'LS', 'Ncom', 'Obstrução', 'MIS', 'AP','Votou')*/
        GROUP BY PMAX.MATERIA,
                 PMAX.PARTIDO,
                 PMAX.RESULTADO,
                 PMAX.DATA
);
/*------------------------------------------------------------------------------------------------------------------------------------------*/

SELECT DISTINCT
VP.materia AS MATERIA,
CONCAT(', MAX(CASE WHEN VP.MATERIA=''',VP.MATERIA,''' THEN VP.SIGLA END) AS "',VP.MATERIA,'"') AS TEXTO
FROM VOTOPARTIDO VP
/*WHERE SUBSTRING(VP.DATA,1,7) BETWEEN '2015-01' AND '2016-08' /*Filtro para selecionar a data do pre ou pos impeachment*/
/*WHERE SUBSTRING(VP.DATA,1,7) BETWEEN '2016-09' AND '2017-12' /*Filtro para selecionar a data do pre ou pos impeachment*/
ORDER BY 1, 2;
/*------------------------------------------------------------------------------------------------------------------------------------------*/

SELECT
VP.PARTIDO
/*Copia e cola o retorno do resultado da coluna TEXTO da query anterior para gerar a transposicao de linhas para colunas, como no exemplo abaixo*/
, MAX(CASE WHEN VP.MATERIA='MPV 00014/2001' THEN VP.SIGLA END) AS "MPV 00014/2001"
, MAX(CASE WHEN VP.MATERIA='MPV 00726/2016' THEN VP.SIGLA END) AS "MPV 00726/2016"
, MAX(CASE WHEN VP.MATERIA='MPV 00727/2016' THEN VP.SIGLA END) AS "MPV 00727/2016"
, MAX(CASE WHEN VP.MATERIA='MPV 00729/2016' THEN VP.SIGLA END) AS "MPV 00729/2016"
, MAX(CASE WHEN VP.MATERIA='MPV 00746/2016' THEN VP.SIGLA END) AS "MPV 00746/2016"
, MAX(CASE WHEN VP.MATERIA='MPV 00759/2016' THEN VP.SIGLA END) AS "MPV 00759/2016"
, MAX(CASE WHEN VP.MATERIA='MPV 00767/2017' THEN VP.SIGLA END) AS "MPV 00767/2017"
, MAX(CASE WHEN VP.MATERIA='MPV 00777/2017' THEN VP.SIGLA END) AS "MPV 00777/2017"
, MAX(CASE WHEN VP.MATERIA='MPV 00782/2017' THEN VP.SIGLA END) AS "MPV 00782/2017"
, MAX(CASE WHEN VP.MATERIA='MPV 00785/2017' THEN VP.SIGLA END) AS "MPV 00785/2017"
, MAX(CASE WHEN VP.MATERIA='MPV 00786/2017' THEN VP.SIGLA END) AS "MPV 00786/2017"
, MAX(CASE WHEN VP.MATERIA='OFS 00070/2017' THEN VP.SIGLA END) AS "OFS 00070/2017"
, MAX(CASE WHEN VP.MATERIA='PEC 00004/2017' THEN VP.SIGLA END) AS "PEC 00004/2017"
, MAX(CASE WHEN VP.MATERIA='PEC 00010/2013' THEN VP.SIGLA END) AS "PEC 00010/2013"
, MAX(CASE WHEN VP.MATERIA='PEC 00014/2016' THEN VP.SIGLA END) AS "PEC 00014/2016"
, MAX(CASE WHEN VP.MATERIA='PEC 00029/2017' THEN VP.SIGLA END) AS "PEC 00029/2017"
, MAX(CASE WHEN VP.MATERIA='PEC 00033/2017' THEN VP.SIGLA END) AS "PEC 00033/2017"
, MAX(CASE WHEN VP.MATERIA='PEC 00036/2016' THEN VP.SIGLA END) AS "PEC 00036/2016"
, MAX(CASE WHEN VP.MATERIA='PEC 00050/2016' THEN VP.SIGLA END) AS "PEC 00050/2016"
, MAX(CASE WHEN VP.MATERIA='PEC 00055/2016' THEN VP.SIGLA END) AS "PEC 00055/2016"
, MAX(CASE WHEN VP.MATERIA='PEC 00064/2016' THEN VP.SIGLA END) AS "PEC 00064/2016"
, MAX(CASE WHEN VP.MATERIA='PEC 00077/2015' THEN VP.SIGLA END) AS "PEC 00077/2015"
, MAX(CASE WHEN VP.MATERIA='PLC 00028/2017' THEN VP.SIGLA END) AS "PLC 00028/2017"
, MAX(CASE WHEN VP.MATERIA='PLC 00038/2017' THEN VP.SIGLA END) AS "PLC 00038/2017"
, MAX(CASE WHEN VP.MATERIA='PLC 00039/2017' THEN VP.SIGLA END) AS "PLC 00039/2017"
, MAX(CASE WHEN VP.MATERIA='PLC 00054/2016' THEN VP.SIGLA END) AS "PLC 00054/2016"
, MAX(CASE WHEN VP.MATERIA='PLC 00080/2015' THEN VP.SIGLA END) AS "PLC 00080/2015"
, MAX(CASE WHEN VP.MATERIA='PLC 00129/2017' THEN VP.SIGLA END) AS "PLC 00129/2017"
, MAX(CASE WHEN VP.MATERIA='PLS 00085/2017' THEN VP.SIGLA END) AS "PLS 00085/2017"
, MAX(CASE WHEN VP.MATERIA='PLS 00086/2017' THEN VP.SIGLA END) AS "PLS 00086/2017"
, MAX(CASE WHEN VP.MATERIA='PLS 00212/2017' THEN VP.SIGLA END) AS "PLS 00212/2017"
, MAX(CASE WHEN VP.MATERIA='PLS 00247/2016' THEN VP.SIGLA END) AS "PLS 00247/2016"
, MAX(CASE WHEN VP.MATERIA='PLS 00345/2017' THEN VP.SIGLA END) AS "PLS 00345/2017"
, MAX(CASE WHEN VP.MATERIA='PLS 00405/2016' THEN VP.SIGLA END) AS "PLS 00405/2016"
, MAX(CASE WHEN VP.MATERIA='PRS 00055/2015' THEN VP.SIGLA END) AS "PRS 00055/2015"
, MAX(CASE WHEN VP.MATERIA='SCD 00007/2016' THEN VP.SIGLA END) AS "SCD 00007/2016"
, MAX(CASE WHEN VP.MATERIA='SCD 00015/2015' THEN VP.SIGLA END) AS "SCD 00015/2015"
/*, VP.RESULTADO*/
FROM VOTOPARTIDO VP
/*WHERE VP.SIGLA IN ('Sim', 'Não') /*Filtro para selecionar apenas votos especificos*/
GROUP BY VP.PARTIDO
ORDER BY VP.PARTIDO;